import { component, resource, event } from "./ecs/Registry";
import { PostUpdate, Startup, Update } from "./ecs/Systems";
import { Entity, World } from "./ecs/World";

// Define the main application class

export class App {
  constructor() {
    const world = new World();

    world.addSystem(Startup, setupSystem);
    world.addSystem(Update, movementSystem);
    world.addSystem(Update, removeSystem);
    world.addSystem(PostUpdate, logSystem);

    world.init();

    setTimeout(() => {
      world.stop();
      console.log("Stopping to prevent log overflow");
    }, 50);
  }
}

// Create some components
const Velocity = component((dx: number = 0, dy: number = 0) => ({
  dx,
  dy,
}));

const Transform = component((x: number = 0, y: number = 0) => ({
  x,
  y,
}));

type DisplayProps = {
  color: string;
  shape?: string;
};

const Display = component((props: DisplayProps) => ({
  shape: "box",
  ...props,
}));

const GameState = resource(() => ({ score: 10 }));

const DeathEvent = event<{ entity: number }>();
// Create systems

// Setup initial entities and properties
const setupSystem = (world: World) => {
  console.log("Setting up the game");

  world.insertResource(GameState());

  // Add entities
  const displayProps: DisplayProps = {
    color: "red",
    shape: "square",
  };

  const display = Display({ color: "red" });

  world.spawn(Velocity(15, 5), Transform(0, 0));
  world.spawn(Velocity(5, 6), Transform(10, 10), display);
  world.spawn(Transform(), Display(displayProps));
};

// Move entities based on their velocity
const movementSystem = (world: World) => {
  const time = world.getResource(Time);
  if (!time) return;

  const query = world.query(Entity, Transform, Velocity);
  const deathWriter = world.getEventWriter(DeathEvent);

  for (const [entity, transform, velocity] of query) {
    transform.x += velocity.dx * time.delta;
    transform.y += velocity.dy * time.delta;
    deathWriter.send({ entity });
  }
};

// Remove all entities with Transform and Display after 2 seconds
const removeSystem = (world: World) => {
  const time = world.getResource(Time);
  const query = world.query(Entity, Transform, Display);
  const deathReader = world.getEventReader(DeathEvent);

  for (const event of deathReader.read()) {
    console.log(`Entity ${event.entity} has moved and is marked for removal.`);
    const x = world.entity(event.entity).inspect();
    console.log(x);

    world.entity(event.entity).despawn();
  }

  if (time && time.elapsed < 2) {
    return;
  }

  for (const [entity] of query) {
    console.log("Removing all entitieees with Transform and display!", entity);
    world.entity(entity).despawn();
  }
};

// Log entity positions and velocities
const logSystem = (world: World) => {
  const time = world.getResource(Time);
  const query = world.query(Entity, Transform, Velocity);

  for (const [entity, transform, velocity] of query) {
    console.log(
      `Entity ${entity} - Position: (${transform.x.toFixed(2)}, ${transform.y.toFixed(2)}) Velocity: (${velocity.dx}, ${velocity.dy})`,
    );
    console.log(
      `Elapsed Time: ${time?.elapsed.toFixed(2)}s, delta: ${time?.delta.toFixed(4)}s`,
    );
  }
};
